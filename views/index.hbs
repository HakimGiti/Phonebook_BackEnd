<html lang='en'>

<head>
  <meta charset='UTF-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0' />
  <title>Phonebook</title>

  <style>
    .myDiv {
      display: block;
      border: 5px outset rgb(13, 241, 51);
      background-color: rgb(7, 176, 233);
      text-align: start;
      padding: 10px;
      height: 30vw;
      overflow-y: scroll;
    }

    table {
      width: 100%;
      gap: 10px;
      text-align: center;
    }

    th {
      color: red;
      font-weight: bold;
    }

    button {
      margin: 5px;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!------------------------------------------->
  <div> Searching Item :
    <input id="SearchingItem" type="text" name="q" placeholder="Name, PhoneNumber or Email" onkeyup="searchLive()" />
  </div>
  <!-------------------------------------------->

  {{#if contacts}}
  <div class='myDiv'>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Phone Number</th>
          <th>Email Address</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="contactTableBody">
        {{#each contacts}}
        <tr>
          <td>{{addOne @index}}</td>
          <td>{{user.name}}</td>
          <td>{{phone}}</td>
          <td>{{email}}</td>
          <td>

            <form onsubmit="handleDelete(event, '{{id}}')">
              <button type="submit">Delete</button>
            </form>
          </td>
        </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
  {{/if}}
  {{#if noContacts}}
  <p style='color: red;'>Contact not found ...!</p>
  {{/if}}

  {{#if noResults}}
  <script>
    document.addEventListener('DOMContentLoaded', () => { document.getElementById("SearchingItem").value = ""; });
  </script>
  <p style="color:red">
    <span style="font-size: x-large; color:blue">{{query}}</span> not found ...!
  </p>
  {{/if}}

  <!-------------------------------------------->
  <h2>افزودن مخاطب جدید</h2>

  {{#if successMessage}}
  <p style="color: green;">{{successMessage}}</p>
  {{/if}}

  {{#if errorMessage}}
  <p style="color: red;">{{errorMessage}}</p>
  {{/if}}

  <form action="/phonebook" method="POST">
    <label>Name:</label>
    <input type="text" name="name" />
    {{!-- <br /> --}}
    <label>PhoneNumber:</label>
    <input type="text" name="phone" required />
    {{!-- <br /> --}}
    <label>Email:</label>
    <input type="email" name="email" />
    {{!-- <br /> --}}
    <button type="submit">Add Contact</button>
  </form>

  {{!-- {{#if newContact}}
  <p>مخاطب جدید: {{newContact.name}} - {{newContact.phone}}</p>
  {{/if}} --}}
  <!-------------------------------------------->

</body>

{{!-- ########################################################################################## --}}
<script>
  // --------------------------------------------------------------------------- Delete Contact
  function confirmDelete(event) {
    const confirmed = confirm("آیا از حذف این مخاطب مطمئن هستید؟");
    if (!confirmed) {
      event.preventDefault(); // جلوی ارسال فرم را می‌گیرد return false; 
    }
    return true; // اجازه حذف
  }

  // --------------------------------------------------------------------------- LiveUpdate
  async function searchLive() {
    const input = document.getElementById("SearchingItem").value;
    try {
      const response = await fetch(`/phonebook/search-json?q=${encodeURIComponent(input)}`);
      const data = await response.json();

      const tbody = document.getElementById("contactTableBody");
      tbody.innerHTML = '';

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="color:red"> ------- نتیجه‌ای یافت نشد ------- </td></tr>';
        return;
      }

      data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
    <td>${index + 1}</td>
    <td>${item.user?.name || ''}</td>
    <td>${item.phone}</td>
    <td>${item.email || ''}</td>
    <td>
      <form action="/phonebook/delete?q=${encodeURIComponent(input)}" method="POST" onsubmit="return confirmDelete(event)">
        <input type="hidden" name="id" value="${item.id}" />
        <button type="submit">Delete</button>
      </form>
    </td>
  `;
        tbody.appendChild(row);
      });

    } catch (err) {
      console.error("خطا در جستجوی زنده:", err);
    }
  }

  //----------------------------------------------------------- HandleDelete
  async function handleDelete(event, id) {
    event.preventDefault();

    if (!confirm("آیا از حذف این مخاطب مطمئن هستید؟")) return;

    const input = document.getElementById("SearchingItem").value;

    const response = await fetch(`/phonebook/delete?q=${encodeURIComponent(input)}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ id })
    });

    if (response.ok) {
      // حذف موفق، حالا دوباره جستجو را اجرا کن
      searchLive();
    } else {
      alert("خطا در حذف مخاطب");
    }
  }


</script>
{{!-- ########################################################################################## --}}


</html>